%% EXAMPLE: Differential drive vehicle following waypoints using the 
% Pure Pursuit algorithm
%
% Copyright 2018-2019 The MathWorks, Inc.
clear all
clc

%% Define Vehicle
R = 0.1;                % Wheel radius [m]
L = 0.5;                % Wheelbase [m]
dd = DifferentialDrive(R,L);

%% Simulation parameters
sampleTime = 0.1;               % Sample time [s]
tVec = 0:sampleTime:483;         % Time array

initPose = [5.3398;11.96;-pi/3];             % Initial pose (x y theta)
pose = zeros(3,numel(tVec));    % Pose matrix
pose(:,1) = initPose;

% Define waypoints
%mi cara 
waypoints = [5.339860487868,11.9604102984174;
            3.053771272754,12.5577803445779;
            2.7206225931646,11.8799950998958;
            2.8355014481954,10.6737671220719;
            3.317992639325,10.685255007575;
            3.4443593798589,11.1677461987045;
            4.4208296476212,11.3285765957477;
            5,11;
            5.3168847168619,10.5244246105318;
            4.8918329532477,10.6278155800595;
            4.2829750215842,10.5244246105318;
            3.6626292044176,10.5129367250287;
            3.1456743567787,10.7771580915996;
            2.8699651047047,10.4899609540225;
            2.915916646717,9.7662241673281;
            2.8929408757109,8.8701690980875;
            3.2835289828158,7.3537682116802;
            3.7889959449515,5.9062946382915;
            4.2944629070873,4.9987516835477;
            4.9952239227755,4.1831118128287;
            5.741936480476,3.3904477131158;
            7,3;
            8.1199287796147,3.5857417666682;
            9.4640113834757,4.4703089504058;
            10.6357757047904,5.711000584739;
            11.26760940746,6.790861822029;
            11.7845642550989,8.7093387010443;
            11.9913461941544,9.8351514803466;
            12.0258098506637,10.7312065495873;
            12,12;
            10,11;
            9.509962925488,10.7886459771027;
            8.8551534518121,10.7426944350904;
            8.1429045506208,10.8345975191151;
            7.5340466189573,10.7197186640842;
            7.9935620390807,11.1792340842076;
            8.6253957417504,11.5927979623187;
            9.372108299451,11.6042858478218;
            9.9809662311145,11.363040252257;
            10.3370906817101,11.2596492827292;
            11.1986820944415,12.3395105200192;
            9.8545994905806,13.0977109632229;
            6.9941160003123,12.442901489547;
            6.7873340612568,11.5583343058094;
            6.6724552062259,10.0419334194022;
            6.6035278932074,8.9161206400998;
            7.0400675423247,8.6863629300381;
            7.4076798784234,8.5255325329949;
            7.5570223899635,8.0889928838777;
            7.4766071914419,7.7558442042882;
            7.1319706263493,7.6294774637543;
            6.8562613742753,7.9051867158283;
            6.5116248091827,7.8936988303252;
            6.2014519005994,7.5835259217419;
            6.0291336180531,6.4002737149241;
            5.5696181979297,6.6185435394828;
            5.2594452893464,6.377297943918;
            5,6;
            5.1101027778063,5.3319003631372;
            5.5006908849112,4.9528001415354;
            6.0176457325501,4.8149455154984;
            6.6724552062259,4.7575060879829;
            7.2008979393678,5.0217274545539;
            7.8557074130437,5.8373673252729;
            7.2928010233925,6.2049796613717;
            6.7413825192444,6.4692010279426;
            6.419721725158,6.5840798829735;
            6.0521093890593,6.4002737149241;
            6.2014519005994,7.5720380362388;
            5.9027668775192,7.5720380362388;
            5.5466424269236,7.7673320897913;
            5.2249816328372,7.9626261433437;
            5.0871270068001,7.7443563187851;
            4.8688571822415,7.9511382578406;
            4.8918329532477,8.3302384794425;
            5.2709331748495,8.8701690980875;
            5.5581303124266,9.2607572051924;
            5.7189607094698,9.9155666788682;
            5.7993759079914,11.363040252257;
            %5.339860487868,11.9604102984174;
            3.053771272754,12.5462924590748;
            2.7206225931646,13.2011019327506;
            3.1456743567787,14.2579873990345;
            3.8119717159577,15.3148728653183;
            5,16;
            6.408233839655,16.2453915910682;
            8.3956380316887,16.2339037055652;
            9.9350146891021,14.6715512771456;
            10.9459486133737,13.4768111848247;
            11.7501005985896,12.5462924590748;
            12.7265708663519,11.7421404738588;
            13.1286468589599,11.0643552291768;
            12.9448406909105,10.2946669004701;
            12.4163979577686,9.4445633732417;
            12.2325917897192,8.7667781285597;
            12.3474706447501,7.8936988303252;
            11.6467096290619,6.3658100584149;
            11.4629034610125,5.3548761341434;
            11.4973671175218,4.7230424314737;
            11.7041490565773,3.8040115912269;
            12.9907922329228,2.6322472699122;
            13.680065363108,2.3565380178381;
            12.9563285764136,4.2865027823564;
            14,6;
            14.2544596382622,7.3652560971833;
            14.4842173483239,9.5939058847819;
            14.6105840888579,11.3975039087662;
            14.5071931193301,12.6956349706149;
            14.4612415773178,14.46476933809;
            13.8294078746481,15.533142689877;
            12.4623494997809,17.1759103168182;
            11.129754781423,17.9915501875372;
            9.0504475053646,18.5314808061822;
            7.4306556494296,18.8646294857717;
            5.604081854439,18.9335567987902;
            3.8004838304546,18.4510656076606;
            1.9509342644579,17.4631074543953;
            1.1697580502481,16.0386096520127;
            0.9859518821987,14.591136078624;
            0.6068516605969,13.924838719445;
            0.2392393244981,13.0747351922167;
            0,12;
            0,11;
            0,10;
            0.1358483549704,8.9505842966091;
            0.6642910881123,7.997089799853;
            0.9285124546833,7.2274014711463;
            1,6;
            0.491972805566,5.1021426530755;
            0.0324573854426,4.5736999199336;
            0,4;
            0.8021457141493,2.2186833918011;
            0.5264364620753,1.3685798645728;
            0.6183395461,0.7482340474062;
            1.2042217067573,0.047473031718;
            1.9624221499609,-0.5613848999456;
            2.238131402035,0.5069884518414;
            2.0428373484825,1.7132164296653;
            3.2375774408034,3.0343232625201;
            4,4;
            4.1566082810502,4.768993973486;
            
            ];


% Create visualizer
viz = Visualizer2D;
viz.hasWaypoints = true;

%% Pure Pursuit Controller
controller = controllerPurePursuit;
controller.Waypoints = waypoints;
controller.LookaheadDistance = 0.2;
controller.DesiredLinearVelocity = 0.3;
controller.MaxAngularVelocity = 25;

%% Simulation loop
close all
r = rateControl(1/sampleTime);
for idx = 2:numel(tVec) 
    % Run the Pure Pursuit controller and convert output to wheel speeds
    [vRef,wRef] = controller(pose(:,idx-1));
    [wL,wR] = inverseKinematics(dd,vRef,wRef);
    
    % Compute the velocities
    [v,w] = forwardKinematics(dd,wL,wR);
    velB = [v;0;w]; % Body velocities [vx;vy;w]
    vel = bodyToWorld(velB,pose(:,idx-1));  % Convert from body to world
    
    % Perform forward discrete integration step
    pose(:,idx) = pose(:,idx-1) + vel*sampleTime; 
    
    % Update visualization
    viz(pose(:,idx),waypoints)
    waitfor(r);
end